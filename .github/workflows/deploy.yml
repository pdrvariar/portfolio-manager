name: "Deploy to Hostinger"

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Baixar o codigo do repositorio
      - name: "Checkout code"
        uses: actions/checkout@v3

      # 2. Configurar o ambiente PHP 8.2
      - name: "Setup PHP"
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo_mysql, mbstring, exif, pcntl, bcmath, gd, zip, intl, opcache
          tools: composer:v2

      # 3. Cache das dependencias para acelerar o processo
      - name: "Cache Composer dependencies"
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}

      # 4. Instalar as dependencias de PRODUCAO no GitHub Actions
      - name: "Install dependencies"
        run: |
          composer install --no-dev --prefer-dist --optimize-autoloader --no-progress
          composer dump-autoload --optimize

      # 5. TRANSFERENCIA DE ARQUIVOS (Passo crucial que faltava)
      # Isso envia tudo, incluindo a pasta 'vendor' gerada acima, para o servidor
      - name: "Copy files via SCP"
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USERNAME }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          source: "./*, !docker, !docker-compose.yml, !init.sql, !README.md"
          # Caminho extraido do seu script original
          target: "/home/${{ secrets.HOSTINGER_USERNAME }}/domains/smartreturns.com.br/public_html"
          # Ignora arquivos desnecessarios na producao
          rm: false
          strip_components: 0


      # 6. Comandos Pos-Deploy via SSH
      - name: "Finalize Deploy via SSH"
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USERNAME }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          script: |
            SITE_PATH="/home/${{ secrets.HOSTINGER_USERNAME }}/domains/smartreturns.com.br/public_html"
            cd $SITE_PATH
            
            # 6.1. Ajustar permissoes de seguranca
            echo "Ajustando permissoes..."
            find . -type f -exec chmod 644 {} \;
            find . -type d -exec chmod 755 {} \;
            
            # 6.2. Permissoes de escrita para pastas especificas se existirem
            [ -d "storage" ] && chmod -R 755 storage/ || true
            [ -d "cache" ] && chmod -R 755 cache/ || true
            [ -d "logs" ] && chmod -R 755 logs/ || true
            
            echo "Deploy finalizado com sucesso!"